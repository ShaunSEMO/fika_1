<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>

    <title>Fika</title>
    <style>
      #mapid { height: 500px; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <a class="navbar-brand" href="{% url 'app:platforms' %}">Fika</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="nav navbar-nav navbar-right">
          {% if user.is_authenticated %}
          <li class="nav-item"><a href="#" onClick="document.getElementById('logout').submit()">Logout</a></li>
          <li class="nav-item">
            <form id="logout" method="POST" action="{% url 'user_accounts:logout' %}">
              {% csrf_token %}
              <input type="hidden">
            </form>
          </li>
          {% else %}
          <li class="nav-item"><a href="{% url 'user_accounts:register' %}">Signup</a></li>
          <li class="nav-item"><a href="{% url 'user_accounts:login' %}">Login</a></li>
          {% endif %}

        </ul>
      </div>
    </nav>
    <div>
      <br><br>
        {% block content %}
        {% endblock %}
    </div>

    <!-- Optional JavaScript -->
    <script>
      $( document ).ready(function() {
        let socket = new WebSocket('ws://192.168.43.195:8000/ws/trackBus')

        socket.onopen = (e) => {
          alert('connection established')
        } 

        socket.onclose = (e) => {
          alert('connection closed')
        }

        var map = L.map('mapid').setView([-26.195246, 28.034088], 13);

        socket.onmessage = (e) => {
          let parsed_data = JSON.parse(e.data);

          L.marker([parsed_data['lat'], parsed_data['lon']]).addTo(map)
            .bindPopup('The bus right here');
          console.log(parsed_data)
        }

        L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=Kp7XziF7klfNmnQetZNl',{
          tileSize: 512,
          zoomOffset: -1,
          minZoom: 1,
          attribution: "\u003ca href=\"https://www.maptiler.com/copyright/\" target=\"_blank\"\u003e\u0026copy; MapTiler\u003c/a\u003e \u003ca href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\"\u003e\u0026copy; OpenStreetMap contributors\u003c/a\u003e",
          crossOrigin: true
        }).addTo(map);

        
      });
    </script>

    <script>
      function geoFindMe() {
        let coord_p = ''
        function success(position) {
          const lat = position.coords.latitude
          const lon = position.coords.longitude
          document.querySelector('#coords-input-lat').value = lat
          document.querySelector('#coords-input-lon').value = lon
        }
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(success)
        }
      }
      window.onload = function() {
        geoFindMe();
      };
    </script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

  </body>
</html>